\documentclass[usenames,dvipsnames]{beamer}
\usepackage{graphicx}
\usepackage{tablefootnote}
\usepackage{bm}
\usepackage{amsmath}
\usepackage{array, booktabs, multicol,hyperref}
\usepackage{ulem}


% Algorithms package
\usepackage[vlined, ruled, lines numbered]{algorithm2e}

% Tikz
\usepackage{tikz}
\usetikzlibrary{shapes}

\usepackage{url}

% LaTeX commands added by CCKM to process tables
% Adjust separation between rows
\renewcommand{\arraystretch}{1.1}
% Commands which allow the width to be set
\newcolumntype{L}[1]{>{\raggedright \let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering   \let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft  \let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

% Augmented vector notation
\newcommand{\av}[2]{\langle #1, #2 \rangle}



\graphicspath{{figures/}{data/}}

\beamertemplatenavigationsymbolsempty

\setbeamertemplate{footline}[frame number]
\definecolor{bostonuniversityred}{rgb}{0.8, 0.0, 0.0}
\usetheme{Copenhagen}

\title[Accuracy and smoothness]{The need for accuracy and smoothness in numerical simulations}

\author[Carl Christian Kjelgaard Mikkelsen et al.]{\underline{Carl Christian Kjelgaard Mikkelsen} \and
Lori{\'e}n L{\'o}pez-Villellas}

\institute{
  Department of Computer Science, Ume{\aa} University, Sweden, \\ {\tt spock@cs.umu.se} \and Department of Computer Science, Zaragoza University, Spain, \\ {\tt lorien.lopez@unizar.es}
}


\date{PPAM 2024, September 8-11th 2024,  Ostrava, Czechia}


\titlegraphic{
  \vspace*{0mm}
  \centering
  \includegraphics[height=1.0cm]{umu-logotyp-EN.png} \;\;
  \includegraphics[height=1.5cm]{Solemne_color.png} \;\;
  \includegraphics[height=1.0cm]{87660_essence_rgb.png}
}

\begin{document}

\frame{\titlepage} 

\frame{\frametitle{Introduction}

  This is not a talk about, say, 
  \vspace{0.5cm}
\begin{enumerate}\setlength\itemsep{1em}
\item computational speed
\item parallelism
\item energy efficency
\end{enumerate}
\vspace{0.5cm}
This is a talk about
\vspace{0.5cm}
\begin{center}
  \underline{the relevance of the numbers returned by our simulations}
\end{center}
}

\frame{\frametitle{Warning: Disturbing pictures to follow}

  We did two sets of simulations of a molecule in water
  \vspace{1cm}
  \begin{enumerate} \setlength\itemsep{1em}
    \item fixed real time
    \item two different force-fields: \texttt{charmm36}, \texttt{oopsaal}
    \item identical initial conditions
   \end{enumerate}
  \vspace{1cm}
  and tracked the energy as a function of the number of steps.

}

\frame{\frametitle{Warning: Disturbing pictures below}

 \begin{figure}
    \includegraphics[width=8cm]{oplsaaltol12.pdf}
  \end{figure}

  \begin{figure}
    \includegraphics[width=8cm]{charmm36tol12.pdf}
  \end{figure}

}




%% \frame{\frametitle{External ballistics}

%%   \includegraphics[width=12cm]{range_rk1_mwe2.pdf}

%%   The total force $\bm{F}$ acting on the shell 
%%   \begin{equation}
%%     \bm{F} = m \bm{g} - \frac{1}{2} \rho(y) A C_D(\nu,y) \|\bm{v} - \bm{w}\|_2 ( \bm{v} - \bm{w} )
%%   \end{equation}
%%   is the combination of gravity and aerodynamic drag.
%% }


%% \frame{\frametitle{External ballistics}

%% \begin{block}{Key questions}
%%   Does it matter
%%   \begin{enumerate}
%%   \item if the drag coefficient
%%     \begin{equation*}
%%       \nu \rightarrow C_D(\nu)
%%     \end{equation*}
%%     is smooth or not?
%%   \item if the event equation
%%     \begin{equation*}
%%       y(t) = 0
%%     \end{equation*}
%%     is solved accurately or not?
%%       \end{enumerate}
%%  \end{block}
%% }


\frame{\frametitle{Molecular dynamics}

  The system of differential algebraic equations
  \begin{align}
  \bm{q}'(t) &= \bm{v}(t), \\
  \bm{M}\bm{v}'(t) &= \bm{f}(\bm{q}(t)) - \bm{G}(\bm{q}(t))^T\bm{\lambda}(t), \\
  \bm{g}(\bm{q}(t)) &= \bm{0}. 
  \end{align}
  is solved using the SHAKE algorithm
  \begin{align}
  \bm{v}_{n+1/2} &= \bm{v}_{n-1/2} + \bm{h} \bm{M}^{-1} \left( \bm{f}(\bm{q}_n) - \bm{G}(\bm{q}_n)^T \bm{\lambda}_n \right), \\
  \bm{q}_{n+1} &= \bm{q}_n + h \bm{v}_{n + 1/2}, \\
  \bm{g}(\bm{q}_{n+1}) &= \bm{0}. \label{equ:constraint}
\end{align}
}

\frame{\frametitle{Molecular dynamics}

  \begin{block}{Key questions}
    Does it matter
    \begin{enumerate}
    \item if the force-field 
      \begin{equation*}
        \bm{q} \rightarrow \bm{f}(\bm{q})
      \end{equation*}
      is smooth or not?
    \item if the nonlinear constraint equation
      \begin{equation}
        \bm{g}(\bm{q}_{n+1}(\bm{\lambda})) = \bm{0}
      \end{equation}
      is solved accurately with respect to $\bm{\lambda}$ or not?
    \end{enumerate}
  \end{block}
}


\frame{\frametitle{The primary point of this talk}
  
  If one of the following is true:
  \vspace{0.5cm}
  \begin{enumerate}
  \item the central functions are not smooth enough
  \item the central equations are not solved accurately enough
  \end{enumerate}
  \vspace{0.5cm}
  then we cannot:
  \vspace{0.5cm}
  \begin{enumerate}
  \item estimate the modelling error
  \item validate the model against the physical reality
  \end{enumerate}
  \vspace{1cm}
}


%% \frame{\frametitle{The secondary point of this talk}

%%   It might be possible to assert experimentally if
%%   \vspace{0.5cm}
%%   \begin{enumerate} \setlength\itemsep{1em}
%%   \item your functions are sufficiently smooth
%%   \item your equations are solved with sufficient accuracy
%%   \end{enumerate}
%% }


\frame{\frametitle{The key terms of this talk}

  \begin{enumerate} \setlength\itemsep{1em}
  \item $P$: physical quantity that can be measured
  \item $T$: approximation of $P$ predicted by our model
  \item $A_h$: approximation of $T$ returned by our algorithm
  \item $\hat{A}_h$: the computed value of $A_h$.
  \end{enumerate}
}

\frame{\frametitle{The three different error terms}

  \begin{enumerate}
  \item $P - T$ is the modelling error and
    \begin{equation}
      P - T \not = 0
    \end{equation}
    because our model is simpler than the real world.
  \item $T - A_h$ is the discretization error and
    \begin{equation}
      T - A_h \not = 0
    \end{equation}
    because we cannot solve most differential equations exactly.
  \item $A_h - \hat{A}_h$ is the computational error and
    \begin{equation}
      A_h - \hat{A}_h \not = 0
    \end{equation}
    due to rounding errors and truncation errors.
  \end{enumerate}
}

\frame{\frametitle{Why should we care?}

  We validate our models by demonstrating that
  \begin{equation}
    P - T \approx 0
  \end{equation}
  is a good approximation, but
  \begin{equation}
    P - T \approx P - \hat{A}_h
  \end{equation}
  is not necessarily a good approximation. We have

  
  \begin{equation}
    P - T = (P - \hat{A}_h) - (T - A_h) - (A_h - \hat{A}_h)
  \end{equation}
  so we need to assert that
  \begin{align}
    |T- A_h| & \ll |P - \hat{A}_h| \\
    |A_h - \hat{A}_h| & \ll |P - \hat{A}_h|
  \end{align}
}

\frame{\frametitle{Practical error estimation}

  It is frequently possible to simultanously
  \begin{enumerate}
  \item assert that the computational error
    \begin{equation*}
      A_h - \hat{A}_h
    \end{equation*}
    is irrelevant, and
  \item estimate the discretization error
    \begin{equation*}
      T_h - A_h
    \end{equation*}
    accurately
  \end{enumerate}
  The key is the existence of an asymptotic error expansion
  \begin{equation}
    E_h = T - A_h = \alpha h^p + \beta h^q + O(h^r), \quad h \rightarrow 0_+
  \end{equation}
  where $0 < p < q < r$.
}

\frame{\frametitle{Elementary results}

Define 
\begin{equation}
  R_h := \frac{A_h - A_{2h}}{2^p - 1}, \quad F_h:= \frac{A_{2h} - A_{4h}}{A_h - A_{2h}} 
\end{equation}
If 
\begin{equation}
  E_h = T - A_h = \alpha h^p + \beta h^q + O(h^r), \quad h \rightarrow 0_+
\end{equation}
then
\begin{equation}
  \frac{E_h - R_h}{h^q} \rightarrow \text{constant}
\end{equation}
and
\begin{equation}
  \frac{2^p - F_h}{h^{q-p}} \rightarrow \text{constant}
\end{equation}
which implies
\begin{equation}
  \log | 2^p - F_h| \approx \log|\text{constant}| + (q-p) \log h
\end{equation}

}

\frame{\frametitle{An example from elementary numerical analysis}

  Our target value is 
  \begin{equation}
    T = \int_0^1 f(x) dx, \quad f(x) = \exp(x)
  \end{equation}
  Our approximation is the composite trapezoidal rule
  \begin{equation}
    A_h = \frac{h}{2} \sum_{j=0}^{n-1} \left( f(x_i) + f(x_{i+1}) \right), \quad x_i = ih, \quad nh = 1
  \end{equation}
  We compute $A_h$ for
  \begin{equation}
    h = h_k = 2^{-k}
  \end{equation}
}

\frame{\frametitle{The evolution of $F_h$ and the quality of $R_h$}

  \begin{figure}[ht]
        \begin{minipage}[b]{0.45\linewidth}
            \centering
            \includegraphics[width=\textwidth]{rint_mwe1a.pdf}
            \caption{The evolution of $F_h$}
            \label{fig:a}
        \end{minipage}
        \hspace{0.5cm}
        \begin{minipage}[b]{0.45\linewidth}
            \centering
            \includegraphics[width=\textwidth]{rint_mwe1b.pdf}
            \caption{The accuracy of $R_h$}
            \label{fig:b}
        \end{minipage}
    \end{figure}
    Strictly speaking we are not observing $F_h$ and $R_h$
  \begin{center}
    we are observing $\hat{F}_h$ and $\hat{R}_h$
  \end{center}
  The discrepancy is controlled by the computational error
  $$ A_h - \hat{A}_h$$
}

\frame{\frametitle{A spectacular failure}

  GROMACS simulation of hen egg white lysozyme in water:
  \vspace{0.25cm}
  \begin{enumerate} \setlength\itemsep{1em}
  \item $T$: total energy of the simulation at the end
  \item $A_h$: the approximation of $T$ computed using SHAKE
  \item $\hat{A}_h$: the value of $A_h$ returned by the computer
  \end{enumerate}
\vspace{0.5cm}
Temporal matters:
\vspace{0.25cm}
  \begin{enumerate}
  \item The length of the simulations was $10^{-12}$ s ($1$ ps)
  \item A common step size in MD is $10^{-15} s$ ($1$ fs)
  \end{enumerate}
  
  \begin{center}
    So, a mere 1000 steps! What could possibly go wrong?
  \end{center}
}

\frame{\frametitle{A spectacular failure}

  \begin{figure}
    \includegraphics[width=10cm]{oplsaaltol12.pdf}
  \end{figure}
   The rapid growth of the energy for large value of $n$ 
    \begin{center}
      can likely be cured using compensated summation.
    \end{center}
  }

\frame{\frametitle{A spectacular failure}

  \begin{figure}
    \includegraphics[width=11cm]{oplsaaltol12.pdf}
  \end{figure}
  
  \begin{itemize}
  \item The \underline{wiggles} near $n=1000$ steps are a great concern.
  \item If there is an AEX, then $1$ fs is \underline{not} inside the asymp. range.
  \item We cannot assert that rounding errors are irrelevant
  \item We cannot estimate the discretication error
  \end{itemize}

}

\frame{\frametitle{What can go wrong?}

  \begin{enumerate}\setlength\itemsep{1.5em}
  \item Proving the existence of an AEX is an exercise in
    \begin{center}
      Taylor expansion
    \end{center}
    We cannot complete the proof unless
    \begin{center}
      the functions are sufficiently smooth.
      \end{center}
    \item We cannot expect $\hat{A}_h$ to behave as predicted by the AEX unless
    $$ \hat{A}_h \approx A_h $$
    is a good approximation
    \end{enumerate}
}



\frame{\frametitle{External ballistics}

  \includegraphics[width=12cm]{range_rk1_mwe2.pdf}

  The total force $\bm{F}$ acting on the shell 
  \begin{equation}
    \bm{F} = m \bm{g} - \frac{1}{2} \rho(y) A C_D(\nu,y) \|\bm{v} - \bm{w}\|_2 ( \bm{v} - \bm{w} )
  \end{equation}
  is the combination of gravity and aerodynamic drag.
}

\frame{\frametitle{Computing the optimal range of the a howitzer}

 \begin{figure}
    \includegraphics[width=10cm]{maxrange_rk1_tol18.pdf} \caption{The evolution of Richardson's fraction for 3 different drag coeffients, Euler's explicit method and sufficiently accurate event location.}
  \end{figure}

}


\frame{\frametitle{Computing the optimal range of the a howitzer}

 \begin{figure}
    \includegraphics[width=10cm]{maxrange_rk1_tol11.pdf} \caption{The evolution of Richardson's fraction for 3 different drag coeffients, Euler's explicit method and inaccurate event location.}
  \end{figure}
 
}

\frame{\frametitle{Modelling ions}




}


\frame{\frametitle{Why should this concern the PPAM community?}

  We use every trick in the book to
  \begin{enumerate}
  \item reduce time-to-solution
  \item increase the parallel efficicency
  \item reduce energy-to-solution
  \end{enumerate}
  \vspace{1cm}
  We should not forget to ask the question:
  \begin{center}
    Did we just compromise our ability to validate our models against the real world?
  \end{center}
}

\end{document}
